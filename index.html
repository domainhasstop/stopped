import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from 'firebase/auth';
import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel } from 'firebase/firestore';

// Aturan penggunaan:
// 1. Dapatkan variabel global dari lingkungan Canvas.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Menggunakan icon lucide-react (diasumsikan tersedia)
const SendIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
);

const UserIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
);

// Komponen Utama Aplikasi Chat
const App = () => {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [userId, setUserId] = useState(null);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const messagesEndRef = useRef(null);

    // Otomatis scroll ke pesan terbaru
    const scrollToBottom = (animate = true) => {
        messagesEndRef.current?.scrollIntoView({ behavior: animate ? "smooth" : "auto" });
    };

    useEffect(() => {
        // Hanya smooth scroll jika ada pesan baru
        if (messages.length > 0) {
            scrollToBottom();
        } else {
            // Scroll instan saat pertama kali dimuat
            scrollToBottom(false);
        }
    }, [messages]);

    // Inisialisasi Firebase dan Autentikasi
    useEffect(() => {
        setLogLevel('debug'); // Aktifkan logging debug untuk Firestore
        
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);

            setAuth(authInstance);
            setDb(dbInstance);

            const handleAuth = async () => {
                if (initialAuthToken) {
                    await setPersistence(authInstance, browserLocalPersistence);
                    await signInWithCustomToken(authInstance, initialAuthToken);
                } else {
                    await signInAnonymously(authInstance);
                }
            };
            
            // Atur listener status autentikasi
            const unsubscribeAuth = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsLoading(false);
                } else {
                    // Jika user terlogout, coba sign in lagi (atau tetap tampilkan ID anonim)
                    setUserId('Authenticating...'); 
                }
            });

            handleAuth().catch(console.error);

            return () => unsubscribeAuth();

        } catch (e) {
            console.error("Gagal menginisialisasi Firebase:", e);
            // Menampilkan error di UI (opsional)
            setUserId('FIREBASE_INIT_ERROR');
            setIsLoading(false);
        }
    }, []);

    // Listener Real-Time Firestore
    useEffect(() => {
        if (db && userId) {
            // Path Koleksi: /artifacts/{appId}/public/data/chats
            const chatCollectionPath = `artifacts/${appId}/public/data/chats`;
            const q = query(collection(db, chatCollectionPath));
            
            const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const fetchedMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Pastikan createdAt adalah objek Timestamp/valid untuk sorting
                    fetchedMessages.push({ id: doc.id, ...data });
                });

                // Sortir pesan secara lokal berdasarkan timestamp karena orderBy() dilarang
                fetchedMessages.sort((a, b) => 
                    (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)
                );
                
                setMessages(fetchedMessages);
                // Scroll dilakukan di useEffect terpisah
            }, (error) => {
                console.error("Error fetching messages:", error);
            });

            return () => unsubscribeSnapshot();
        }
    }, [db, userId]);

    // Fungsi Pengiriman Pesan
    const sendMessage = async (e) => {
        e.preventDefault();
        if (!newMessage.trim() || !db || !userId) return;

        try {
            const chatCollectionPath = `artifacts/${appId}/public/data/chats`;
            await addDoc(collection(db, chatCollectionPath), {
                text: newMessage,
                createdAt: serverTimestamp(),
                senderId: userId,
            });
            setNewMessage('');
        } catch (error) {
            console.error("Gagal mengirim pesan:", error);
        }
    };

    // --- Rendering Logic ---

    if (isLoading || !userId || userId === 'Authenticating...') {
        return (
            <div className="flex justify-center items-center h-screen bg-gray-100">
                {/* Menggunakan warna biru */}
                <div className="text-xl font-medium text-blue-600 animate-pulse">
                    ðŸš€ Loading Customer Care... Mohon menunggu yaa!
                </div>
            </div>
        );
    }

    const formatTime = (timestamp) => {
        if (!timestamp) return "Sending..."; // Diubah ke Inggris karena ini di dalam kode JS
        const date = timestamp.toDate();
        // Format waktu lebih singkat dan santai
        return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    };

    // Komponen Kartu Pesan
    const MessageCard = ({ message }) => {
        const isSentByCurrentUser = message.senderId === userId;
        // Styling bubble chat lebih cerah dan menggunakan box shadow yang 'pop'
        const baseStyles = "max-w-[85%] p-3 rounded-2xl shadow-xl transition-all duration-300 ease-in-out mb-2 text-sm";
        
        return (
            <div className={`flex ${isSentByCurrentUser ? 'justify-end' : 'justify-start'}`}>
                <div className={`${baseStyles} 
                    ${isSentByCurrentUser 
                        // Pesan sendiri menggunakan biru
                        ? 'bg-blue-600 text-white rounded-br-md transform hover:scale-[1.02]' 
                        // Pesan lawan menggunakan putih
                        : 'bg-white text-gray-800 rounded-tl-md border border-gray-100 shadow-md hover:shadow-lg transform hover:scale-[1.02]'
                    }
                `}>
                    {!isSentByCurrentUser && (
                        // Penampilan ID pengirim diubah jadi lebih pendek dan fun
                        <div className="font-bold text-xs mb-1 break-all text-blue-700">
                            Anon ({message.senderId.substring(message.senderId.length - 4)}):
                        </div>
                    )}
                    <p className="whitespace-pre-wrap">{message.text}</p>
                    {/* Timestamp dibuat lebih kecil dan 'tersembunyi' */}
                    <div className={`text-[9px] mt-1 ${isSentByCurrentUser ? 'text-blue-200' : 'text-gray-400'} text-right`}>
                        {formatTime(message.createdAt)}
                    </div>
                </div>
            </div>
        );
    };

    // Antarmuka Utama
    return (
        <div className="flex flex-col h-screen antialiased bg-white font-inter">
            {/* Header */}
            <div className="flex items-center justify-between p-4 bg-white shadow-2xl fixed top-0 left-0 right-0 z-10 md:h-20 border-b-4 border-blue-600">
                <h1 className="text-2xl font-extrabold text-blue-700 hidden sm:block">
                    âœ… Customer Care GARUDA Investment
                </h1>
                <div className="flex items-center space-x-2 p-2 bg-blue-100 rounded-full text-blue-800 text-xs sm:text-sm shadow-inner">
                    <UserIcon className="w-5 h-5 text-blue-600"/>
                    <span className="font-semibold hidden sm:inline">Akunmu:</span>
                    <span className="font-mono break-all text-xs sm:text-sm">
                        {/* ID dipersingkat di display utama */}
                        {userId.substring(0, 4)}...{userId.substring(userId.length - 4)}
                    </span>
                    <span className="text-xs font-medium bg-blue-300 text-blue-900 px-2 py-0.5 rounded-full ml-2">
                        {appId.substring(0, 6)}
                    </span>
                </div>
                {/* ID Lengkap (Wajib ditampilkan untuk kolaborasi) */}
                <div className="absolute top-0 right-0 p-1 bg-gray-200 text-[8px] text-gray-700 overflow-hidden break-all max-w-full">
                    UID Lengkap: {userId}
                </div>
            </div>

            {/* Area Pesan */}
            <div className="flex-grow overflow-y-auto p-4 pt-[90px] pb-[90px] sm:pt-24 sm:pb-24 bg-gray-50">
                <div className="max-w-4xl mx-auto flex flex-col space-y-3">
                    {messages.length === 0 ? (
                        // Pesan kosong yang lebih santai
                        <div className="text-center text-gray-500 italic mt-10">
                            Halo! Ada yang bisa kami bantu? Sampaikan pertanyaan investasi Anda di sini. ðŸ“ˆ
                        </div>
                    ) : (
                        messages.map((msg) => (
                            <MessageCard key={msg.id} message={msg} />
                        ))
                    )}
                    <div ref={messagesEndRef} />
                </div>
            </div>

            {/* Input Pesan (Fixed Footer) */}
            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white shadow-3xl border-t-4 border-blue-600/50">
                <form onSubmit={sendMessage} className="max-w-4xl mx-auto flex space-x-3">
                    <input
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        // Placeholder yang lebih gaul
                        placeholder="Tulis pesanmu ke Customer Care..."
                        className="flex-grow p-3 border-2 border-blue-300 rounded-2xl focus:ring-4 focus:ring-blue-300 focus:border-blue-600 transition duration-200 text-gray-700 placeholder-gray-400"
                        disabled={!db || !userId}
                    />
                    <button
                        type="submit"
                        // Button dengan gradient biru
                        className="p-3 bg-gradient-to-r from-blue-600 to-cyan-700 text-white rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.05] transition duration-200 active:scale-[0.98] disabled:opacity-50 flex items-center justify-center font-bold"
                        disabled={!db || !userId || !newMessage.trim()}
                    >
                        <SendIcon className="w-6 h-6 mr-1"/>
                        Kirim
                    </button>
                </form>
            </div>
        </div>
    );
};

export default App;
